<!DOCTYPE html>
<html>
	<head>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
		<script type="importmap">
			{ 
				"imports": {
					"three": "https://cdn.jsdelivr.net/npm/three@0.164.0/build/three.module.js",
					"csg/": "https://cdn.jsdelivr.net/gh/looeee/threejs-csg@main/src/CSG/"
				} 
			}
		</script>
	</head>
	<body>
		<script type="module">
			import * as THREE from "three";
			import {CSG} from "csg/CSG.js";
			
			var renderer = new THREE.WebGLRenderer();
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.setAnimationLoop(drawFrame);
			document.body.appendChild(renderer.domElement);

			const scene = new THREE.Scene();
			scene.background = new THREE.Color("white");
			
			const aspect = window.innerWidth / window.innerHeight;
			const camera = new THREE.PerspectiveCamera(30, aspect);
			camera.position.set(0, 10, 30);
			camera.lookAt(new THREE.Vector3(0, 6, 0));
			
			const light = new THREE.PointLight('white', 900);
			light.position.set(0, 5, 10);
			scene.add(light);

			const ground = new THREE.Mesh(
				new THREE.PlaneGeometry(100, 100),
				new THREE.MeshPhongMaterial({ color: "gray" })
			);

			ground.rotation.x = -Math.PI / 2;
			scene.add(ground);
			
			const material = new THREE.MeshPhongMaterial({
				color: "green",
				transparent: true,
				opacity: 0.9,
				side: THREE.DoubleSide
			});

			const bottle = new THREE.Mesh(
				new THREE.CylinderGeometry(1, 1, 3, 32),
				material
			);

			const bottleUpper = new THREE.Mesh(
				new THREE.CylinderGeometry(0.5, 1, 2, 32, 32, true),
				material
			);

			const bottleUpperUpper = new THREE.Mesh(
				new THREE.CylinderGeometry(0.2, 0.5, 2, 32, 32, true),
				material
			);

			bottleUpperUpper.position.y = 2
			bottleUpper.add(bottleUpperUpper);

			bottleUpper.position.y = 2.5
			bottle.add(bottleUpper);

			bottle.position.set(-10, 2.5, 0);
			bottle.rotation.z = -Math.PI / 4;

			scene.add(bottle);

			const cork = new THREE.Mesh(
				new THREE.CylinderGeometry(0.25, 0.2, 0.4, 32),
				new THREE.MeshPhongMaterial({color:"brown"})
			);

			cork.position.set(-10 + 5.5 * Math.cos(Math.PI / 4), 2.5 + 5.5 * Math.sin(Math.PI / 4), 0);
			cork.rotation.z = -Math.PI / 4;
			
			scene.add(cork);

			let energy = 0.1, forceY = 0.4, phi = 0, r = 0.1, rotCenter = null;

			function drawFrame(t) {
				if (t < 500) {
					renderer.render(scene, camera);
					return;
				}

				if (cork.position.y > 0.2) {
					cork.position.y = Math.max(cork.position.y + forceY, 0.2);
				}

				forceY -= 0.01;

				if (t > 600) {
					forceY -= 0.1;
				}

				if (t < 700) {
					cork.position.x += 0.4;
					cork.lookAt(0.4, forceY, 0);
				} else if (energy > 0) {
					if (rotCenter == null) {
						rotCenter = cork.position;
					}

					phi += energy;
					//r += energy / 10000;
					cork.position.set(rotCenter.x + r * Math.cos(phi), rotCenter.y, rotCenter.z + r * Math.sin(phi));
					energy -= 0.001;
				}

				//scene.rotation.y = t / 1000;
				renderer.render(scene, camera);
			}
		</script>
	</body>
</html>